
-- 1. Criar Tabela de Perfis
CREATE TABLE IF NOT EXISTS public.profiles (
    id TEXT PRIMARY KEY, 
    name TEXT NOT NULL,
    avatar_url TEXT DEFAULT 'https://api.dicebear.com/7.x/avataaars/svg?seed=FreeFire',
    wins INTEGER DEFAULT 0,
    matches INTEGER DEFAULT 0,
    total_score INTEGER DEFAULT 0,
    last_seen TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. Criar Tabela de Amizades
CREATE TABLE IF NOT EXISTS public.friendships (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id TEXT REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    friend_id TEXT REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(user_id, friend_id)
);

-- 3. Habilitar RLS (Segurança)
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.friendships ENABLE ROW LEVEL SECURITY;

-- 4. Criar Políticas (Remover antigas para evitar conflito)
DO $$ 
BEGIN
    DROP POLICY IF EXISTS "Acesso público perfis" ON public.profiles;
    DROP POLICY IF EXISTS "Acesso público amizades" ON public.friendships;
END $$;

CREATE POLICY "Acesso público perfis" ON public.profiles FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Acesso público amizades" ON public.friendships FOR ALL USING (true) WITH CHECK (true);

-- 5. Habilitar Realtime de forma segura
-- Este bloco evita o erro "publication defined as FOR ALL TABLES"
DO $$
BEGIN
    -- Verifica se a publicação existe
    IF EXISTS (SELECT 1 FROM pg_publication WHERE pubname = 'supabase_realtime') THEN
        -- Verifica se ela NÃO é do tipo 'FOR ALL TABLES'
        IF NOT EXISTS (SELECT 1 FROM pg_publication WHERE pubname = 'supabase_realtime' AND puballtables = true) THEN
            -- Se for específica, tentamos adicionar as tabelas
            BEGIN
                ALTER PUBLICATION supabase_realtime ADD TABLE public.profiles;
            EXCEPTION WHEN OTHERS THEN 
                RAISE NOTICE 'Tabela profiles já estava na publicação ou erro ignorado.';
            END;
            
            BEGIN
                ALTER PUBLICATION supabase_realtime ADD TABLE public.friendships;
            EXCEPTION WHEN OTHERS THEN 
                RAISE NOTICE 'Tabela friendships já estava na publicação ou erro ignorado.';
            END;
        ELSE
            RAISE NOTICE 'Realtime já está habilitado para TODAS as tabelas. Ignorando inclusão manual.';
        END IF;
    END IF;
END $$;
